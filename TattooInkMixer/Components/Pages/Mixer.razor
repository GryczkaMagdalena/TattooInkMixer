@page "/"
@page "/mixer"
@rendermode InteractiveServer
@using TattooInkMixer.Services

<MudGrid Spacing="3">
    <MudItem xs="12" md="7">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">My colors (@Inks.Count)</MudText>

            <MudTable Items="Inks" Dense="true" Hover="true" Bordered="true" Striped="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Color</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudTextField T="string" Value="@context.Name" ValueChanged="@(value => context.Name = value)" Immediate="true" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudTd>
                    <MudTd>
                        <div class="color-editor">
                            <label class="color-swatch" style="@GetColorPreviewStyle(context.Hex)">
                                <input type="color" value="@GetColorInputValue(context.Hex)" @oninput="@(e => UpdateColorFromPicker(context, e.Value?.ToString()))" />
                            </label>

                            <MudTextField T="string"
                                          Label="HEX"
                                          Value="@context.Hex"
                                          ValueChanged="@(value => UpdateColorFromHex(context, value))"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />

                            <MudTextField T="string"
                                          Label="RGB"
                                          Value="@HexToRgbText(context.Hex)"
                                          ValueChanged="@(value => UpdateColorFromRgb(context, value))"
                                          Immediate="true"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                        </div>
                    </MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => Remove(context.Id)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Add" OnClick="Add" Class="mt-3">Add color</MudButton>

            @if (Result is not null)
            {
                <MudText Typo="Typo.h6" Class="mt-4">Recipe</MudText>
                <ul>
                    @for (int i = 0; i < Inks.Count; i++)
                    {
                        var w = Result.Weights[i];
                        if (w > 1e-6)
                        {
                            <li>@Inks[i].Name (@Inks[i].Hex): <b>@(100 * w).ToString("0.00")%</b></li>
                        }
                    }
                </ul>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="5">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">Requested color</MudText>

            <MudTextField T="string" Label="Target (#RRGGBB)" Variant="Variant.Outlined" @bind-Value="TargetHex" />
            <div class="mt-2" style="@GetColorPreviewStyle(TargetHex)"></div>

            <MudNumericField T="int" Label="Max inks to use" Variant="Variant.Outlined" Min="1" Max="20" Class="mt-4" @bind-Value="MaxInks" />

            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Solve" Class="mt-4">Mix</MudButton>

            @if (!string.IsNullOrWhiteSpace(Error))
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-3">@Error</MudAlert>
            }

            @if (Result is not null)
            {
                <MudDivider Class="my-4" />
                <MudText>
                    Predicted mix: <b>@Result.PredictedHex</b>
                </MudText>
                <div class="mt-2" style="@GetColorPreviewStyle(Result.PredictedHex)"></div>
                <MudText Class="mt-2">Error (RMSE): @Result.ErrorRmse.ToString("0.000000")</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string TargetHex = "#FF8800";
    private int MaxInks = 4;
    private string? Error;

    private InkMixResult? Result;

    private List<InkRow> Inks =
    [
        new("Red", "#D81B1B"),
        new("Green", "#1BBE4B"),
        new("Blue", "#1B4FD8"),
        new("Black", "#101010"),
        new("White", "#FFFFFF")
    ];

    private static string GetColorPreviewStyle(string hex) => $"background:{hex}; width:48px; height:28px; border:1px solid #999; border-radius:4px;";

    private static string GetColorInputValue(string hex)
    {
        try
        {
            _ = Rgb.FromHex(hex);
            return hex;
        }
        catch
        {
            return "#808080";
        }
    }

    private static string HexToRgbText(string hex)
    {
        try
        {
            var rgb = Rgb.FromHex(hex);
            return $"{rgb.R}, {rgb.G}, {rgb.B}";
        }
        catch
        {
            return string.Empty;
        }
    }

    private static void UpdateColorFromPicker(InkRow ink, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return;

        ink.Hex = value.ToUpperInvariant();
    }

    private static void UpdateColorFromHex(InkRow ink, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            ink.Hex = string.Empty;
            return;
        }

        ink.Hex = value.Trim();
    }

    private static void UpdateColorFromRgb(InkRow ink, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return;

        var parts = value.Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length != 3)
            return;

        if (!byte.TryParse(parts[0], out var r) || !byte.TryParse(parts[1], out var g) || !byte.TryParse(parts[2], out var b))
            return;

        ink.Hex = $"#{r:X2}{g:X2}{b:X2}";
    }

    private void Add()
    {
        Inks.Add(new InkRow($"Ink {Inks.Count + 1}", "#808080"));
        Result = null;
    }

    private void Remove(Guid id)
    {
        var idx = Inks.FindIndex(x => x.Id == id);
        if (idx >= 0)
            Inks.RemoveAt(idx);

        Result = null;
    }

    private void Solve()
    {
        Error = null;
        Result = null;

        try
        {
            _ = Rgb.FromHex(TargetHex);
            foreach (var ink in Inks) _ = Rgb.FromHex(ink.Hex);

            var hexes = Inks.Select(x => x.Hex).ToList();
            Result = InkMixSolver.SolveWithLimit(hexes, TargetHex, MaxInks);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
    }

    private sealed class InkRow
    {
        public Guid Id { get; } = Guid.NewGuid();
        public InkRow(string name, string hex) { Name = name; Hex = hex; }
        public string Name { get; set; }
        public string Hex { get; set; }
    }
}
